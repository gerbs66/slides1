<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/black.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
    <style>
      .code-block {
        font-size: 1.5rem;
        line-height: 1.5rem;
      }

      .slide-container {
        display: flex;
        gap: 1rem;
      }

      .scene {
        width: 50%;
      }

      section .code-wrapper {
        flex-grow: 1;
        width: 50%;
      }

      p {
        color: black;
      }

      .container {
        border-radius: 1rem;
        background: white;
        height: 500px;
        overflow: hidden;
      }
    </style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">

        <section>
          <h3>Centering a DIV WITH BLUE</h3>
          <div class="slide-container">
            <!-- Visible code block -->
            <pre>
              <code class="code-block hljs" data-trim contenteditable="true" data-line-numbers="3,8-10">
              <style>
                .container {
                  align-content: center;
                  background: blue;
                }
                .box {
                  width: 50px;
                  height: 50px;
                  background: salmon;
                }
              </style>
              </code>
            </pre>
        
            <!-- Hidden code block -->
            <script type="text/template" class="hidden-code-block">
              <div class="container">
                <p class="content">I am sentence</p>
                <p class="content">Lorem Ipsum</p>
              </div>
            </script>
        
            <!-- Data-edit container -->
            <div class="scene" data-edit></div>
          </div>
        </section>

        <section>
          <h3>Centering a DIV 2</h3>
          <div class="slide-container">
            <!-- Visible code block -->
            <pre>
              <code class="code-block hljs" data-trim contenteditable="true" data-line-numbers="3,8-10">
              <style>
                .container {
                  align-content: center;
                }
                .box {
                  width: 50px;
                  height: 50px;
                  background: salmon;
                }
              </style>
              </code>
            </pre>
        
            <!-- Hidden code block -->
            <script type="text/template" class="hidden-code-block">
              <div class="container">
                <p class="content">I am sentence</p>
                <p class="content">Lorem Ipsum</p>
              </div>
            </script>
        
            <!-- Data-edit container -->
            <div class="scene" data-edit></div>
          </div>
        </section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script type="module">
			import Editor from './plugin/editor/editor.esm.js';

			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
        highlight: {
          highlightOnLoad: false, // Disable automatic highlighting
        },
				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, Editor ]
			});

			Reveal.on('slidechanged', (event) => {
				if(event.currentSlide.dataset.execute) {

					console.log('going to eval', event.currentSlide.dataset.execute);
					let result = eval(event.currentSlide.dataset.execute);
					let $result = event.currentSlide.querySelector('p.result');
					$result.innerHTML = result;
				}
			});

			Reveal.on('ready', () => {
				// Find all sections containing a code block and a data-edit div
				document.querySelectorAll('section .slide-container').forEach((container) => {
					const codeBlock = container.querySelector('.code-block'); // Visible code block
					const hiddenCodeBlock = container.querySelector('.hidden-code-block'); // Hidden code block
					const dataEditDiv = container.querySelector('[data-edit]');
			
					if (codeBlock && dataEditDiv) {
						// Function to update data-edit with content from both blocks
						const updateDataEdit = () => {
              const visibleContent = codeBlock.textContent;
              const hiddenContent = hiddenCodeBlock ? hiddenCodeBlock.textContent : "";

              // Populate the data-edit div with combined content (renders as actual HTML)
              dataEditDiv.innerHTML = `
                ${visibleContent}
                ${hiddenContent}
              `;
            };

						// Initial update of data-edit
						updateDataEdit();
			
						// Apply initial syntax highlighting
						const highlight = Reveal.getPlugin('highlight');
						highlight.highlightBlock(codeBlock);
			
						// Add event listener for input changes in the visible code block
						codeBlock.addEventListener('input', () => {
							const selection = window.getSelection();
							const range = selection.getRangeAt(0);
							const preHighlightCaretPosition = getCaretCharacterOffsetWithin(codeBlock);
			
							// Remove 'data-highlighted' and reapply highlighting
							codeBlock.removeAttribute('data-highlighted');
							codeBlock.className = 'code-block hljs';
							highlight.highlightBlock(codeBlock);
			
							// Restore caret position
							setCaretAtCharacterOffset(codeBlock, preHighlightCaretPosition);
			
							// Update the data-edit div
							updateDataEdit();
						});
					}
				});
			
				// Helper functions for caret position
				function getCaretCharacterOffsetWithin(element) {
					const selection = window.getSelection();
					let caretOffset = 0;
					if (selection.rangeCount > 0) {
						const range = selection.getRangeAt(0);
						const preCaretRange = range.cloneRange();
						preCaretRange.selectNodeContents(element);
						preCaretRange.setEnd(range.startContainer, range.startOffset);
						caretOffset = preCaretRange.toString().length;
					}
					return caretOffset;
				}
			
				function setCaretAtCharacterOffset(element, offset) {
					const selection = window.getSelection();
					const range = document.createRange();
					let charCount = 0,
						found = false;
			
					function traverseNodes(node) {
						if (node.nodeType === Node.TEXT_NODE) {
							const nextCharCount = charCount + node.length;
							if (!found && offset >= charCount && offset <= nextCharCount) {
								range.setStart(node, offset - charCount);
								range.collapse(true);
								found = true;
							}
							charCount = nextCharCount;
						} else {
							for (let i = 0; i < node.childNodes.length; i++) {
								traverseNodes(node.childNodes[i]);
								if (found) break;
							}
						}
					}
			
					traverseNodes(element);
					selection.removeAllRanges();
					selection.addRange(range);
				}
			});
		</script>
	</body>
</html>

<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

		<title>reveal.js</title>

		<link rel="stylesheet" href="dist/reset.css">
		<link rel="stylesheet" href="dist/reveal.css">
		<link rel="stylesheet" href="dist/theme/black.css">

		<!-- Theme used for syntax highlighted code -->
		<link rel="stylesheet" href="plugin/highlight/monokai.css">
    <style>
      .reveal .hljs table {
          width: 100%;
      }
      /* .code-block {
        font-size: 1.5rem;
        line-height: 1.5rem;
      } */

      .slide-container {
        display: flex;
        gap: 1rem;
      }

      .scene {
        width: 50%;
      }

      section .code-wrapper {
        flex-grow: 1;
        width: 50%;
      }

      p {
        color: black;
      }

      .container {
        border-radius: 1rem;

        font-size: 1.5rem;
        line-height: 1.5rem;
        background: white;
        height: 500px;
        overflow: hidden;
      }
    </style>
	</head>
	<body>
		<div class="reveal">
			<div class="slides">

         <section id="section3">
          <h3>Centering a DIV WITH BLUE</h3>
          <div class="slide-container">
            <!-- Visible code block -->
            <pre>
              <code class="code-block hljs" data-trim contenteditable="true" data-line-numbers="3,8-10">
              <style>
                .container {
                  align-content: center;
                }
              </style>
              </code>
            </pre>
        
            <!-- Hidden code block -->
            <script type="text/template" class="hidden-code-block">
              <div class="container">
                <p class="content">I am sentence</p>
                <p class="content">Lorem Ipsum</p>
              </div>
            </script>
        
            <!-- Data-edit container -->
            <div class="scene" data-edit></div>
          </div>
        </section>

        <section id="section1">
          <h3>Centering a DIV WITH BLUE</h3>
          <div class="slide-container">
            <!-- Visible code block -->
            <pre>
              <code class="code-block hljs" data-trim contenteditable="true" data-line-numbers="3,8-10">
              <style>
                .container {
                  align-content: center;
                }
              </style>
              </code>
            </pre>
        
            <!-- Hidden code block -->
            <script type="text/template" class="hidden-code-block">
              <div class="container">
                <p class="content">I am sentence</p>
                <p class="content">Lorem Ipsum</p>
              </div>
            </script>
        
            <!-- Data-edit container -->
            <div class="scene" data-edit></div>
          </div>
        </section>

        <section id="section2">
          <h3>Centering a DIV 2</h3>
          <div class="slide-container">
            <!-- Visible code block -->
            <pre>
              <code class="code-block hljs" data-trim contenteditable="true" data-line-numbers="3,8-10">
              <style>
                .container {
                  align-content: center;
                }
                .box {
                  width: 50px;
                  height: 50px;
                  background: salmon;
                }
              </style>
              </code>
            </pre>
        
            <!-- Hidden code block -->
            <script type="text/template" class="hidden-code-block">
              <div class="container">
                <p class="content">I am sentence</p>
                <p class="content">Lorem Ipsum</p>
              </div>
            </script>
        
            <!-- Data-edit container -->
            <div class="scene" data-edit></div>
          </div>
        </section>
			</div>
		</div>

		<script src="dist/reveal.js"></script>
		<script src="plugin/notes/notes.js"></script>
		<script src="plugin/markdown/markdown.js"></script>
		<script src="plugin/highlight/highlight.js"></script>
		<script type="module">
			import Editor from './plugin/editor/editor.esm.js';

      /**
       * Given raw CSS text and a scope selector (e.g. '#section1'),
       * this function prefixes each selector with the scope.
       *
       * Note: This is a simplistic approach that assumes:
       * - CSS blocks are in a <style> tag without nested rules.
       * - Selectors do not include edge-cases like commas in strings.
       *
       * You might need a more robust parser for production use.
       */
       function scopeCSS(cssText, scope) {
        // This regex finds selectors and the block following them.
        // Explanation:
        // - ([^{}]+?) matches one or more characters (non-greedily) that aren't { or } (the selectors).
        // - \s*\{ matches the opening brace (with possible whitespace)
        // - ([^}]*?) matches the property block until the closing brace.
        // - \} matches the closing brace.
        const cssRuleRegex = /([^{}]+?)\s*\{([^}]*?)\}/g;

        return cssText.replace(cssRuleRegex, (match, selectors, declarations) => {
          // Process each selector in the comma-separated list
          const scopedSelectors = selectors
            .split(',')
            .map(sel => {
              let trimmed = sel.trim();
              // Skip if the selector already starts with the scope
              if (trimmed.indexOf(scope) === 0) {
                return trimmed;
              }
              // Also, if the selector starts with an at-rule (e.g. @keyframes, @media) or is a percentage value, skip prefixing.
              if (trimmed.startsWith('@') || trimmed.match(/^[\d\.%]+$/)) {
                return trimmed;
              }
              return scope + ' ' + trimmed;
            })
            .join(', ');
          return scopedSelectors + ' {' + declarations + '}';
        });
      }


			// More info about initialization & config:
			// - https://revealjs.com/initialization/
			// - https://revealjs.com/config/
			Reveal.initialize({
				hash: true,
        highlight: {
          highlightOnLoad: false, // Disable automatic highlighting
        },
				// Learn about plugins: https://revealjs.com/plugins/
				plugins: [ RevealMarkdown, RevealHighlight, RevealNotes, Editor ]
			});

			Reveal.on('slidechanged', (event) => {
				if(event.currentSlide.dataset.execute) {

					console.log('going to eval', event.currentSlide.dataset.execute);
					let result = eval(event.currentSlide.dataset.execute);
					let $result = event.currentSlide.querySelector('p.result');
					$result.innerHTML = result;
				}
			});

			Reveal.on('ready', () => {
				// Find all sections containing a code block and a data-edit div
				document.querySelectorAll('section .slide-container').forEach((container) => {
					const codeBlock = container.querySelector('.code-block'); // Visible code block
					const hiddenCodeBlock = container.querySelector('.hidden-code-block'); // Hidden code block
					const dataEditDiv = container.querySelector('[data-edit]');
			    // Get the parent section for scoping (assuming an id is provided on the <section>)
          const section = container.closest('section');
          const sectionScope = section.id ? `#${section.id}` : '';

					if (codeBlock && dataEditDiv) {
            codeBlock.dataset.rawContent = codeBlock.innerText;

            // Function to update data-edit with combined & processed content
            const updateDataEdit = () => {
              // Gather raw content from the two code blocks.
              const visibleContent = codeBlock.textContent;
              const hiddenContent = hiddenCodeBlock ? hiddenCodeBlock.textContent : '';
              
              // Combine both contents.
              let combinedContent = visibleContent + "\n" + hiddenContent;
              
              // Process any <style> tags in the combined content to scope them.
              combinedContent = combinedContent.replace(/<style>([\s\S]*?)<\/style>/gi, (match, cssContent) => {
                // Apply the scoping based on the current slideâ€™s unique identifier.
                const scopedCSS = scopeCSS(cssContent, sectionScope);
                return `<style>${scopedCSS}</style>`;
              });
              
              // Update the data-edit container with the modified content.
              dataEditDiv.innerHTML = combinedContent;
            };
						// // Function to update data-edit with content from both blocks
						// const updateDataEdit = () => {
            //   const visibleContent = codeBlock.textContent;
            //   const hiddenContent = hiddenCodeBlock ? hiddenCodeBlock.textContent : "";

            //   // Populate the data-edit div with combined content (renders as actual HTML)
            //   dataEditDiv.innerHTML = `
            //     ${visibleContent}
            //     ${hiddenContent}
            //   `;
            // };

						// Initial update of data-edit
						updateDataEdit();
			
						// Apply initial syntax highlighting
						const highlight = Reveal.getPlugin('highlight');
						highlight.highlightBlock(codeBlock);
			
						// Add event listener for input changes in the visible code block
            codeBlock.addEventListener('input', () => {
              // Save the plain text version in a data attribute
              codeBlock.dataset.rawContent = codeBlock.innerText; 
              updateDataEdit();
            });
						// codeBlock.addEventListener('input', () => {
            //   updateDataEdit();

						// 	const selection = window.getSelection();
						// 	const range = selection.getRangeAt(0);
						// 	const preHighlightCaretPosition = getCaretCharacterOffsetWithin(codeBlock);
			
						// 	// Remove 'data-highlighted' and reapply highlighting
						// 	codeBlock.removeAttribute('data-highlighted');
						// 	codeBlock.className = 'code-block hljs';
						// 	highlight.highlightBlock(codeBlock);
			
						// 	// Restore caret position
						// 	setCaretAtCharacterOffset(codeBlock, preHighlightCaretPosition);
			
						// 	// Update the data-edit div
						// 	updateDataEdit();
						// });
					}
				});

        function getCaretCharacterOffsetWithin(element) {
          const selection = window.getSelection();
          let caretOffset = 0;
          if (selection.rangeCount > 0) {
            const range = selection.getRangeAt(0);
            const preCaretRange = range.cloneRange();
            preCaretRange.selectNodeContents(element);
            preCaretRange.setEnd(range.startContainer, range.startOffset);
            // Instead of using toString() on the DOM, use the stored raw content.
            // This assumes that codeBlock.dataset.rawContent is up to date.
            caretOffset = preCaretRange.toString().length;
          }
          return caretOffset;
        }

        function setCaretAtCharacterOffset(element, offset) {
          const selection = window.getSelection();
          const range = document.createRange();
          let charCount = 0, found = false;

          // A helper function that traverses only text nodes
          function traverseNodes(node) {
            if (node.nodeType === Node.TEXT_NODE) {
              const nextCharCount = charCount + node.length;
              if (!found && offset >= charCount && offset <= nextCharCount) {
                range.setStart(node, offset - charCount);
                range.collapse(true);
                found = true;
              }
              charCount = nextCharCount;
            } else {
              for (let i = 0; i < node.childNodes.length; i++) {
                traverseNodes(node.childNodes[i]);
                if (found) break;
              }
            }
          }
          traverseNodes(element);
          selection.removeAllRanges();
          selection.addRange(range);
        }
			});
		</script>
	</body>
</html>
